<!DOCTYPE html>
<html lang="en" class="bg-[#0c0c0c]">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LionLamb Phonic Sounds Story Box</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }
        .container {
            max-width: 800px;
        }
        .message-box {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #4CAF50;
            color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            z-index: 100;
        }
        .message-box.show {
            opacity: 1;
        }
    </style>
</head>
<body class="bg-[#0c0c0c] text-gray-200 flex items-center justify-center min-h-screen p-4">

    <div id="message-box" class="message-box"></div>

    <div class="container bg-[#15273c] shadow-xl rounded-2xl p-6 md:p-10 flex flex-col items-center">
        <div class="w-full flex justify-center mb-6">
            <h1 class="text-4xl md:text-5xl font-bold text-orange-400 text-center">LionLamb Phonic Sounds Story Box</h1>
        </div>

        <div id="api-key-setup" class="w-full space-y-4">
            <p class="text-sm text-center">
                To begin, please enter your API key. This will be stored locally in your browser.
            </p>
            <input type="password" id="api-key-input" placeholder="Enter your Google AI Studio API Key" class="w-full p-3 rounded-lg border border-blue-700 bg-blue-950 text-gray-200 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-orange-400 transition duration-300">
            <button id="save-key-button" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:ring-4 focus:ring-orange-400 transition duration-300 ease-in-out transform hover:scale-105">
                Save Key
            </button>
        </div>

        <div id="app-interface" class="w-full space-y-4 hidden">
            <p class="text-sm text-center">
                Generate a short story by entering a prompt or selecting a phonic sound.
            </p>

            <div class="flex flex-col md:flex-row items-center space-y-4 md:space-y-0 md:space-x-4">
                <input type="text" id="prompt-input" placeholder="e.g., A playful dog barking" class="flex-1 w-full p-3 rounded-lg border border-blue-700 bg-blue-950 text-gray-200 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-orange-400 transition duration-300">
                <select id="phonics-select" class="w-full md:w-auto p-3 rounded-lg border border-blue-700 bg-blue-950 text-gray-200 focus:outline-none focus:ring-2 focus:ring-orange-400 transition duration-300">
                    <option value="" disabled selected>Or choose a sound...</option>
                    <option value="a">/a/</option>
                    <option value="b">/b/</option>
                    <option value="c">/c/</option>
                    <option value="d">/d/</option>
                    <option value="e">/e/</option>
                    <option value="f">/f/</option>
                    <option value="g">/g/</option>
                    <option value="h">/h/</option>
                    <option value="i">/i/</option>
                    <option value="j">/j/</option>
                    <option value="k">/k/</option>
                    <option value="l">/l/</option>
                    <option value="m">/m/</option>
                    <option value="n">/n/</option>
                    <option value="o">/o/</option>
                    <option value="p">/p/</option>
                    <option value="q">/q/</option>
                    <option value="r">/r/</option>
                    <option value="s">/s/</option>
                    <option value="t">/t/</option>
                    <option value="u">/u/</option>
                    <option value="v">/v/</option>
                    <option value="w">/w/</option>
                    <option value="x">/x/</option>
                    <option value="y">/y/</option>
                    <option value="z">/z/</option>
                    <option value="sh">/sh/</option>
                    <option value="ch">/ch/</option>
                    <option value="th">/th/</option>
                    <option value="wh">/wh/</option>
                    <option value="ai">/ai/</option>
                    <option value="ee">/ee/</option>
                    <option value="ie">/ie/</option>
                    <option value="oa">/oa/</option>
                    <option value="ue">/ue/</option>
                    <option value="oo">/oo/</option>
                </select>
            </div>
            
            <button id="generate-button" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:ring-4 focus:ring-orange-400 transition duration-300 ease-in-out transform hover:scale-105">
                Generate Story
            </button>
        </div>

        <div id="loader" class="hidden my-6">
            <div class="flex flex-col items-center">
                <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-orange-400"></div>
                <p class="mt-4 text-center">Generating your story and image...</p>
            </div>
        </div>

        <div id="result-container" class="hidden w-full mt-8 space-y-6">
            <div class="flex justify-center">
                <img id="story-image" src="" alt="Generated Story Image" class="w-full h-auto rounded-lg shadow-lg max-h-96 object-contain">
            </div>

            <div class="relative bg-blue-900 p-6 rounded-lg shadow-inner">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-2xl font-bold text-orange-400">Your Story</h2>
                    <div class="flex space-x-2">
                        <button id="audio-button" class="text-orange-400 hover:text-orange-500 transition duration-300">
                            <i class="fas fa-volume-up fa-2x"></i>
                        </button>
                        <button id="copy-button" class="text-gray-300 hover:text-gray-100 transition duration-300">
                            <i class="fas fa-copy fa-2x"></i>
                        </button>
                    </div>
                </div>
                <div id="story-text" class="text-lg leading-relaxed max-h-64 overflow-y-auto"></div>
            </div>
        </div>
    </div>

    <script>
        const API_KEY_STORAGE_KEY = 'lionlamb_api_key';
        let API_KEY = localStorage.getItem(API_KEY_STORAGE_KEY) || '';

        const GENERATE_TEXT_API = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
        const GENERATE_IMAGE_API = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${API_KEY}`;
        const GENERATE_AUDIO_API = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${API_KEY}`;
        
        const promptInput = document.getElementById('prompt-input');
        const phonicsSelect = document.getElementById('phonics-select');
        const generateButton = document.getElementById('generate-button');
        const loader = document.getElementById('loader');
        const resultContainer = document.getElementById('result-container');
        const storyImage = document.getElementById('story-image');
        const storyText = document.getElementById('story-text');
        const audioButton = document.getElementById('audio-button');
        const copyButton = document.getElementById('copy-button');
        const messageBox = document.getElementById('message-box');
        const apiKeySetup = document.getElementById('api-key-setup');
        const appInterface = document.getElementById('app-interface');
        const apiKeyInput = document.getElementById('api-key-input');
        const saveKeyButton = document.getElementById('save-key-button');

        let audioInstance;
        let storyContent = "";

        // Helper functions
        function showMessage(message, type = 'success') {
            messageBox.textContent = message;
            messageBox.style.backgroundColor = type === 'success' ? '#4CAF50' : '#f44336';
            messageBox.classList.add('show');
            setTimeout(() => {
                messageBox.classList.remove('show');
            }, 3000);
        }

        // Check for API key on page load
        if (API_KEY) {
            apiKeySetup.classList.add('hidden');
            appInterface.classList.remove('hidden');
        } else {
            apiKeySetup.classList.remove('hidden');
            appInterface.classList.add('hidden');
        }

        // Save key button logic
        saveKeyButton.addEventListener('click', () => {
            const key = apiKeyInput.value.trim();
            if (key) {
                localStorage.setItem(API_KEY_STORAGE_KEY, key);
                API_KEY = key;
                apiKeySetup.classList.add('hidden');
                appInterface.classList.remove('hidden');
                showMessage("API key saved successfully!", "success");
            } else {
                showMessage("Please enter a valid API key.", "error");
            }
        });

        // Retry with exponential backoff
        async function fetchWithBackoff(url, options, retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status === 429) {
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        console.warn(`Rate limit exceeded. Retrying in ${delay / 1000}s...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return await response.json();
                } catch (error) {
                    if (i === retries - 1) {
                        throw error;
                    }
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    console.warn(`Fetch failed. Retrying in ${delay / 1000}s...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        async function generateStory(prompt) {
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: {
                    parts: [{ text: "You are a friendly and creative children's story writer. Write a short, simple, engaging story for children in Nigeria. Use culturally familiar settings, names like Halima or Femi, and common objects found in a Nigerian village. The story should be 2-3 paragraphs long and focus on the provided prompt or a phonic sound." }]
                }
            };
            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            };
            const result = await fetchWithBackoff(GENERATE_TEXT_API, options);
            return result?.candidates?.[0]?.content?.parts?.[0]?.text || 'Failed to generate story.';
        }

        async function generateImage(story) {
            let characterGender = "a child";
            let characterName = "the main character";
            if (story.includes("Halima")) {
                characterGender = "a young girl";
                characterName = "Halima";
            } else if (story.includes("Femi")) {
                characterGender = "a young boy";
                characterName = "Femi";
            }
            const imagePrompt = `A vibrant children's book illustration in a Nigerian village. Show ${characterGender}, a child named ${characterName}, tending to hens and chickens in a warm, friendly and cheerful style.`;
            
            const payload = {
                instances: { prompt: imagePrompt },
                parameters: { "sampleCount": 1 }
            };
            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            };
            const result = await fetchWithBackoff(GENERATE_IMAGE_API, options);
            const base64Data = result?.predictions?.[0]?.bytesBase64Encoded;
            return base64Data ? `data:image/png;base64,${base64Data}` : '';
        }

        async function generateAudio(text) {
            const payload = {
                contents: [{ parts: [{ text: text }] }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            prebuiltVoiceConfig: { voiceName: "Iapetus" }
                        }
                    }
                },
                model: "gemini-2.5-flash-preview-tts"
            };
            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            };
            const result = await fetchWithBackoff(GENERATE_AUDIO_API, options);
            const part = result?.candidates?.[0]?.content?.parts?.[0];
            const audioData = part?.inlineData?.data;
            const mimeType = part?.inlineData?.mimeType;

            if (audioData && mimeType) {
                const sampleRate = parseInt(mimeType.match(/rate=(\d+)/)[1], 10);
                const pcmData = base64ToArrayBuffer(audioData);
                const pcm16 = new Int16Array(pcmData);
                const wavBlob = pcmToWav(pcm16, sampleRate);
                return URL.createObjectURL(wavBlob);
            }
            return null;
        }

        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function pcmToWav(pcmData, sampleRate) {
            const wavData = new ArrayBuffer(44 + pcmData.length * 2);
            const view = new DataView(wavData);
            let offset = 0;

            function writeString(str) {
                for (let i = 0; i < str.length; i++) {
                    view.setUint8(offset++, str.charCodeAt(i));
                }
            }

            function writeUint32(val) {
                view.setUint32(offset, val, true);
                offset += 4;
            }

            function writeUint16(val) {
                view.setUint16(offset, val, true);
                offset += 2;
            }

            writeString('RIFF');
            writeUint32(36 + pcmData.length * 2);
            writeString('WAVE');
            writeString('fmt ');
            writeUint32(16);
            writeUint16(1);
            writeUint16(1);
            writeUint32(sampleRate);
            writeUint32(sampleRate * 2);
            writeUint16(2);
            writeUint16(16);
            writeString('data');
            writeUint32(pcmData.length * 2);

            for (let i = 0; i < pcmData.length; i++) {
                view.setInt16(offset, pcmData[i], true);
                offset += 2;
            }

            return new Blob([view], { type: 'audio/wav' });
        }
        
        // Event Listeners
        generateButton.addEventListener('click', async () => {
            // Check for API key before attempting API calls
            if (!API_KEY) {
                showMessage("Please enter and save your API key first.", "error");
                return;
            }

            const promptValue = promptInput.value.trim();
            const phonicSound = phonicsSelect.value;
            let combinedPrompt;

            if (promptValue && phonicSound) {
                combinedPrompt = `A short story for children about ${promptValue}, with a special focus on words containing the '${phonicSound}' sound.`;
            } else if (promptValue) {
                combinedPrompt = `A short story for children about ${promptValue}.`;
            } else if (phonicSound) {
                combinedPrompt = `A short story for children with a special focus on words containing the '${phonicSound}' sound.`;
            } else {
                showMessage("Please enter a prompt or select a phonic sound.", "error");
                return;
            }

            // Hide previous results and show loader
            resultContainer.classList.add('hidden');
            loader.classList.remove('hidden');

            try {
                // Generate content in sequence
                const story = await generateStory(combinedPrompt);
                const imageBase64 = await generateImage(story);

                storyContent = story.replace(/\*\*/g, ''); // Remove Markdown bolding
                storyText.innerHTML = storyContent.replace(/\n/g, '<br><br>');
                storyImage.src = imageBase64 || "https://placehold.co/600x400/3182CE/FFFFFF?text=Image+Not+Available";

                // Generate audio after the story is received
                const audioUrl = await generateAudio(storyContent);
                if (audioUrl) {
                    if (audioInstance) audioInstance.pause();
                    audioInstance = new Audio(audioUrl);
                    audioButton.disabled = false;
                } else {
                    audioButton.disabled = true;
                    showMessage("Audio generation failed.", "error");
                }

                // Show results
                loader.classList.add('hidden');
                resultContainer.classList.remove('hidden');

            } catch (error) {
                console.error("Error during generation:", error);
                loader.classList.add('hidden');
                resultContainer.classList.add('hidden');
                showMessage("An error occurred during generation. Please try again.", "error");
            }
        });

        audioButton.addEventListener('click', () => {
            if (audioInstance) {
                audioInstance.play();
            } else {
                showMessage("Audio not available.", "error");
            }
        });

        copyButton.addEventListener('click', () => {
            if (storyContent) {
                const el = document.createElement('textarea');
                el.value = storyContent;
                document.body.appendChild(el);
                el.select();
                document.execCommand('copy');
                document.body.removeChild(el);
                showMessage("Story copied to clipboard!");
            }
        });
    </script>
</body>
</html>
